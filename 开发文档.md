# 开发文档

本文档介绍“导师模拟器”的结构、核心模块与扩展方式，便于协作与维护。

## 技术栈与结构
- 前端：Vite + React + TypeScript
- 样式：`src/index.css` 与 `src/App.css`
- 后端：Node 服务 + LLM 请求封装（`server/lib/llmClient.js`）

## 核心文件
- `src/App.tsx`：主界面与交互逻辑（申请阶段 + 导师控制台）
- `src/logic/gameState.ts`：导师核心状态与季度结算
- `src/data/studentTraits.ts`：学生特质库（主/副特质 + 极性）
- `server/index.js`：后端 API 入口（Express）
- `server/services/profileGenerator.js`：导师档案与自我激励生成
- `server/services/studentGenerator.js`：学生信息生成与规范化
- `接口文档.md`：后端 REST 接口说明（前后端数据契约）

接口详细字段与示例见 `接口文档.md`。开发模式下 Vite 代理 `/api/*` 到后端（见 `vite.config.ts`）。

## 关键机制
### 1. 事件记录
右侧栏“新消息”展示事件列表，事件由 `pushEvent` 统一写入，包含：
- 招募与面试通过
- 导师分配
- 安抚与激励
- 心态活动
- 季度结算

### 2. 学生招募与面试
- 招募请求：`/api/students`（mode = recruit）
- 生成后转为正式学生卡，并写入“面试通过”事件
- 15% 概率爽约：不生成学生，改为调用 `POST /api/events/recruit-no-show` 生成爽约理由并弹窗提示

### 3. 特质规则
- 主特质（人格型）1 个 + 副特质（诙谐型）2-3 个
- 特质与数值的直接关联已取消，仅在指导结算时间接影响

### 4. 导师指导
- 手动选择导师与被指导者
- 每季度结束时应用指导影响
- UI 显示“正在指导/正在被指导”状态

### 5. 安抚与激励
- 安抚：消耗经费，提升心态并降低压力
- 激励：提升论文进度与勤奋，但增加压力并降低心态
- 每名学生每季度各一次

### 6. 科研系统（课题 / 经费 / 论文）
- 课题与经费：在“科研面板”中创建课题；国自然/国社科走“申报→三季度评审事件+运气得分→A/B/C 档资助→执行期产出论文与结题判定”的新机制（前端：`settleGrants` + 决策类型 `grantReviewEvent`/`grantExecutionEvent`；事件文本由后端 LLM 生成：`POST /api/events/grant-review`、`POST /api/events/grant-execution`）。
- 课题推进：季度结算时调用 `advanceProjects` 推进文献/实验/结果进度；未分配学生时不推进。
- 论文产出：季度结算时调用 `settleResearchPapers`，按学生天赋/勤奋/运势推进 `contribution`（常规单季度增量 20%-40%，天赋≥90 且运势/状态强时有概率触发约 80%±20% 的爆发）并在达标后自动投稿；随后可能触发“学生论文事件”选择题（后端：`/api/events/student-paper`），玩家选择后结算接收/退稿/继续返修及数值变化。
- 课题论文：课题结题会生成 `projectPapers` 并进入 `pendingDecisions` 队列（前端弹窗 `DecisionModal`）；外审到期在季度结算中判定接收/拒稿/返修，并继续生成返修决策。

### 7. 季度随机事件（校务通知）
- 点击“结束本季度”后进入“结算中”遮罩页，后端并发生成多条随机事件（`POST /api/events/quarterly-batch`）并加入 `pendingDecisions` 队列。
- 部分事件会定向到某个学生（`targetStudentId`），玩家选择后会结算到该学生身上；offer 去留类事件会触发学生离队并自动清理课题/项目/论文分配。

## 扩展建议
- 将事件记录持久化（localStorage 或后端存储）
- 增加学生成长阶段（研二/研三）与更细的论文工作流（投稿期刊选择 / 改稿 / 返修）
- 细化导师特质与院系 buff 的影响规则

---
如需更多细节，优先阅读 `src/App.tsx` 与 `server/services/studentGenerator.js`。
