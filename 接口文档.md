# 接口文档

本文档描述后端 Express API（`server/index.js`）对外提供的 REST 接口。

## 1. 基础信息
- 默认后端端口：`4000`（可通过 `API_PORT` 或 `PORT` 覆盖）
- 响应格式：`application/json`
- 开发代理：Vite 会将浏览器侧的 `/api/*` 代理到后端（见 `vite.config.ts`）
- 错误格式：`{ "error": "..." }`（HTTP 500）
- 说明：多数 `POST` 接口会调用 LLM，可能较慢；生成失败会降级为内置样例/兜底数据

## 2. Profile（导师档案）
### GET /api/profile
返回当前后端内存中的导师档案。

**Response 200**
```json
{
  "mentor": "导师姓名",
  "biography": "简介",
  "researchAreas": ["方向1", "方向2"],
  "recruitmentNeeds": ["需求1", "需求2"],
  "achievements": ["成就1", "成就2"],
  "quote": "一句话",
  "motivation": "自我激励（可选）"
}
```

### POST /api/profile
根据教职申请表单生成并覆盖当前导师档案。

**Request body**
```json
{
  "name": "导师姓名",
  "gender": "性别/称谓（可选）",
  "almaMater": "毕业院校（可选）",
  "discipline": "学科大类（可选）",
  "department": "院系（可选）",
  "researchFocus": "研究方向（可选）"
}
```

**Response 200** 同 GET /api/profile

### POST /api/profile/generate
基于传入种子重新生成档案内容（用于调试/二次生成），并覆盖当前导师档案。

**Request body**
```json
{
  "biographySeed": "简介种子（可选）",
  "areas": ["方向种子（可选）"],
  "recruitmentNeeds": ["招生需求种子（可选）"],
  "achievements": ["成果种子（可选）"]
}
```

**Response 200** 同 GET /api/profile

## 3. Students（学生画像）
### GET /api/students
返回当前后端内存中的学生列表（数组）。

### POST /api/students
生成学生画像。`mode` 决定是否“追加招募”。

**Request body**
```json
{
  "mentor": "导师姓名（可选）",
  "department": "院系（可选）",
  "researchFocus": "研究方向（可选）",
  "count": 1,
  "mode": "initial | recruit"
}
```

- `count`：1-6（会被后端限制）
- `mode=initial`：覆盖后端的 `currentStudents`
- `mode=recruit`：在现有学生基础上追加，并只返回本次新生成的学生数组

**Response 200**
返回学生数组（字段较多，前端以 `src/App.tsx` 的 `StudentPersona` 为准）。关键字段示例：
```json
[
  {
    "id": "student-xxx",
    "name": "张三",
    "studentType": "MASTER",
    "year": 1,
    "diligence": 70,
    "stress": 18,
    "talent": 66,
    "luck": 58,
    "hiddenLuck": 82,
    "contribution": 0,
    "pendingPapers": 0,
    "totalPapers": 0,
    "mentalState": 96,
    "traits": ["卷王", "内卷永动机", "嘴硬心软"],
    "whipReactions": { "success": ["..."], "fail": ["..."] },
    "comfortReactions": { "success": ["..."], "fail": ["..."] },
    "department": "计算机科学与技术学院"
  }
]
```

## 4. Projects（课题）
### POST /api/projects/title
生成课题名称。

**Request body**
```json
{
  "discipline": "学科大类（可选）",
  "department": "院系（可选）",
  "researchFocus": "研究方向（可选）",
  "category": "校内课题 | 横向合作 | 自由探索"
}
```

**Response 200**
```json
{ "title": "课题名称" }
```

## 5. Events（随机事件）
### POST /api/events/student-paper
生成“学生论文投稿/返修”选择题事件。

**Request body**
```json
{
  "student": {
    "id": "student-xxx",
    "name": "张三",
    "studentType": "MASTER",
    "year": 1,
    "traits": ["..."],
    "pendingPapers": 0,
    "totalPapers": 0,
    "contribution": 12
  },
  "mentor": {
    "name": "导师姓名",
    "researchFocus": "研究方向",
    "selectedDiscipline": "学科大类",
    "selectedDepartment": "院系"
  },
  "year": 1,
  "quarter": 3
}
```

**Response 200**
```json
{
  "title": "事件标题",
  "prompt": "题干",
  "options": [
    {
      "id": "A",
      "label": "选项",
      "hint": "可选提示",
      "outcome": "结果描述",
      "effects": {
        "stats": { "funding": -2000, "reputation": 1, "morale": -1 },
        "student": { "stress": 3, "mentalState": -2, "pendingPapers": 0 }
      }
    }
  ]
}
```

- `effects.stats` 支持：`funding` / `reputation` / `morale` / `academia` / `admin` / `integrity`（学术不端嫌疑）
- `effects.student` 支持：`stress` / `mentalState` / `pendingPapers` / `totalPapers` / `contribution` / `diligence` / `talent` / `luck`

### POST /api/events/recruit-no-show
生成“招募候选人爽约”提示理由（由大模型根据导师档案/数值/团队情况生成），前端用于弹窗展示。

**Request body**
```json
{
  "mentor": {
    "name": "导师姓名",
    "discipline": "学科大类",
    "department": "院系",
    "researchFocus": "研究方向",
    "biography": "简历",
    "achievements": ["..."],
    "recruitmentNeeds": ["..."]
  },
  "stats": {
    "year": 2,
    "quarter": 3,
    "morale": 86,
    "academia": 62,
    "admin": 55,
    "integrity": 18,
    "funding": 120000,
    "reputation": 14
  },
  "team": {
    "members": [
      {
        "name": "张三",
        "stage": "研二",
        "mainTrait": "卷王",
        "subTraits": ["..."]
      }
    ]
  }
}
```

**Response 200**
```json
{ "reason": "候选人爽约理由..." }
```

### POST /api/events/quarterly-batch
季度结算时批量生成“校务通知/随机事件”（选择题事件），供前端加入“待处理决策”队列。
后端会并发调用 LLM 生成 `count` 条事件；生成失败会降级返回内置兜底事件。

**Request body**
```json
{
  "year": 2,
  "quarter": 3,
  "count": 3,
  "mentor": {
    "name": "导师姓名",
    "discipline": "学科大类",
    "department": "院系",
    "researchFocus": "研究方向",
    "biography": "简历",
    "achievements": ["..."],
    "recruitmentNeeds": ["..."]
  },
  "stats": {
    "year": 2,
    "quarter": 3,
    "morale": 86,
    "academia": 62,
    "admin": 55,
    "integrity": 18,
    "funding": 120000,
    "reputation": 14
  },
  "team": {
    "members": [
      {
        "id": "student-xxx",
        "name": "张三",
        "stage": "研二",
        "traits": ["卷王", "深夜修复侠"],
        "diligence": 70,
        "talent": 66,
        "luck": 58,
        "pendingPapers": 1,
        "totalPapers": 0
      }
    ]
  }
}
```

- `count`：1-5（默认 3）
- `team.members`：建议传入团队摘要（例如最多 10 人），用于让事件更贴合当前团队

**Response 200**
```json
{
  "events": [
    {
      "category": "notification | offer | crisis | policy | team",
      "targetStudentId": "student-xxx",
      "title": "校务通知：……",
      "prompt": "事件题干（长文本）",
      "options": [
        {
          "id": "A",
          "label": "选项文案",
          "hint": "可选提示",
          "outcome": "选择后的结果描述",
          "effects": {
            "stats": { "funding": -2000, "reputation": 1, "morale": -1 },
            "student": { "stress": 3, "mentalState": -2 }
          },
          "meta": { "studentAction": "leave | stay" }
        }
      ]
    }
  ]
}
```

### POST /api/events/grant-review
生成“国自然/国社科申报评审事件”（选择题），用于申报当季与评审期间的季度随机事件。

**Request body**
```json
{
  "year": 2,
  "quarter": 1,
  "mode": "submission | review",
  "grant": {
    "id": "grant-xxx",
    "type": "国自然",
    "title": "项目标题",
    "baseScore": 68,
    "scoreDelta": 0,
    "luck": 3
  },
  "mentor": { "name": "导师姓名", "discipline": "学科大类", "department": "院系", "researchFocus": "研究方向" },
  "stats": { "morale": 86, "academia": 62, "admin": 55, "integrity": 18, "funding": 120000, "reputation": 14 },
  "team": { "members": [{ "id": "student-xxx", "name": "张三", "stage": "研一", "traits": ["..."] }] }
}
```

**Response 200**
```json
{
  "title": "事件标题",
  "prompt": "题干",
  "options": [
    {
      "id": "A",
      "label": "选项",
      "hint": "可选提示",
      "outcome": "结果描述",
      "effects": { "stats": { "admin": -1 }, "student": { "stress": 2 } },
      "meta": { "scoreDelta": 4, "luckDelta": 1 }
    }
  ]
}
```

- `mode=submission`：申报当季材料/背书事件；`mode=review`：评审期间季度事件
- `meta.scoreDelta` / `meta.luckDelta`：影响该课题的最终评分与运气累计（前端用于更新 `GrantState.scoreDelta/luck`）

### POST /api/events/grant-execution
生成“国自然/国社科执行期事件”（选择题），用于执行期的季度机会/风险决策。

**Request body**
```json
{
  "year": 2,
  "quarter": 4,
  "grant": { "id": "grant-xxx", "type": "国社科", "title": "项目标题", "tier": "B", "paperProgress": 35 },
  "mentor": { "name": "导师姓名", "discipline": "学科大类", "department": "院系", "researchFocus": "研究方向" },
  "stats": { "morale": 86, "academia": 62, "admin": 55, "integrity": 18, "funding": 120000, "reputation": 14 },
  "team": { "members": [{ "id": "student-xxx", "name": "张三", "stage": "研二", "traits": ["..."] }] }
}
```

**Response 200**
```json
{
  "title": "事件标题",
  "prompt": "题干",
  "options": [
    {
      "id": "A",
      "label": "选项",
      "hint": "可选提示",
      "outcome": "结果描述",
      "effects": { "stats": { "funding": -8000 }, "student": { "mentalState": -1 } },
      "meta": { "progressDelta": 12 }
    }
  ]
}
```

- `meta.progressDelta`：影响该课题的写作/产出进度（前端用于更新 `GrantState.paperProgress`）

## 6. Reset（重置）
### POST /api/reset
重置后端内存状态（导师档案回到 seed，学生清空）。

**Response 200**
```json
{ "ok": true }
```
